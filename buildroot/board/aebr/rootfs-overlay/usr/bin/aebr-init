#!/bin/sh

# Mount /boot if we need to
if ! mountpoint -q /boot; then
  if grep -q "rpi.platform=true" /proc/cmdline; then
    mount -o ro,defaults /dev/mmcblk0p1 /boot
  fi
fi

if [ -f /boot/aebr.conf ]; then
    . /boot/aebr.conf
fi


if [ -n "$HOSTNAME" ]; then
    hostname "$HOSTNAME"
fi

# set up root ssh login
mkdir -p /run/dropbear

if [ "$DISABLE_SSH_ROOT_PASSWORD_LOGIN" == "y" ]; then
    cat << EOF > /run/dropbear/default
# ssh in as root via password is disabled (use /boot/aebr.conf's SSH_ROOT_AUTHORIZED_KEY instead)
DROPBEAR_ARGS="-g"
EOF
else
    cat << EOF > /run/dropbear/default
# ssh in as root via password is allowed
#DROPBEAR_ARGS="-g"
EOF
fi

if [ -n "$SSH_ROOT_AUTHORIZED_KEY" ]; then
    echo $SSH_ROOT_AUTHORIZED_KEY > /run/dropbear/authorized_keys
fi

# Default wifi region to US
if [ -z "$WIFI_REGION" ]; then
  WIFI_REGION="US"
fi

# Set up iwd
mkdir -p /run/iwd
cat << EOF > /run/iwd/main.conf
[General]
EnableNetworkConfiguration=true
CountryCode=$WIFI_REGION

[Network]
NameResolvingService=systemd
EOF
if [ -n "$WIFI_SSID" ] && [ -n "$WIFI_PASSWORD" ]; then
    mkdir -p /var/lib/iwd
    cat << EOF > "/var/lib/iwd/${WIFI_SSID}.psk"
[Security]
Passphrase=$WIFI_PASSWORD
EOF
fi
